<script>
const form          = document.getElementById('questionarioForm');
const btnSubmit     = document.getElementById('btnSubmit');
const successScreen = document.getElementById('successScreen');
const formContainer = document.getElementById('formContainer');
const counterEl     = document.getElementById('counter');

const altroChk      = document.getElementById('rb-altro');
const altroWrapper  = document.getElementById('altro-wrapper');

// Mostra/nasconde "Altro"
altroChk.addEventListener('change', () => {
    altroWrapper.style.display = altroChk.checked ? 'block' : 'none';
    if (!altroChk.checked) document.getElementById('altro-reparto').value = '';
});

// Contatore report
function updateCounter() {
    let count = 0;
    for (let i = 1; i <= 5; i++) {
        if (document.getElementById('r' + i).value.trim()) count++;
    }
    counterEl.textContent = count + ' / 5 report inseriti';
    counterEl.className = 'report-counter ' + 
        (count >= 3 ? 'good' : count >= 1 ? 'medium' : '');
}
document.querySelectorAll('#r1,#r2,#r3,#r4,#r5').forEach(el => el.addEventListener('input', updateCounter));
updateCounter();

// Pulisci errori durante la digitazione
form.querySelectorAll('input, textarea').forEach(field => {
    field.addEventListener('input', () => {
        field.classList.remove('error');
        const err = document.getElementById('err-' + field.id);
        if (err) err.classList.remove('show');
    });
});

// Validazione rigorosa
function validate() {
    let valid = true;

    // Nome
    const nome = document.getElementById('nome').value.trim();
    document.getElementById('nome').classList.toggle('error', !nome);
    document.getElementById('err-nome')?.classList.toggle('show', !nome);
    if (!nome) valid = false;

    // Cognome
    const cognome = document.getElementById('cognome').value.trim();
    document.getElementById('cognome').classList.toggle('error', !cognome);
    document.getElementById('err-cognome')?.classList.toggle('show', !cognome);
    if (!cognome) valid = false;

    // Email
    const emailVal = document.getElementById('email').value.trim();
    let emailOk = emailVal && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailVal);
    document.getElementById('email').classList.toggle('error', !emailOk);
    document.getElementById('err-email')?.classList.toggle('show', !emailOk);
    if (!emailOk) valid = false;

    // Almeno un reparto
    const repartiOk = document.querySelectorAll('#reparti input:checked').length > 0;
    document.getElementById('err-reparti')?.classList.toggle('show', !repartiOk);
    if (!repartiOk) valid = false;

    // Almeno un report
    let reportCount = 0;
    for (let i = 1; i <= 5; i++) {
        if (document.getElementById('r' + i).value.trim()) reportCount++;
    }
    const reportOk = reportCount >= 1;
    document.getElementById('err-report')?.classList.toggle('show', !reportOk);
    document.getElementById('err-report').textContent = reportOk ? "" : "Inserisci almeno un report importante";
    if (!reportOk) valid = false;

    // Scroll al primo errore
    if (!valid) {
        const firstError = form.querySelector('.error, .error-message.show');
        if (firstError) firstError.scrollIntoView({behavior: 'smooth', block: 'center'});
    }

    return valid;
}

// Submit bloccato se non valido
form.addEventListener('submit', async e => {
    e.preventDefault();

    if (!validate()) {
        return;   // ← BLOCCA l'invio
    }

    btnSubmit.disabled = true;
    btnSubmit.classList.add('loading');
    btnSubmit.textContent = 'Invio in corso…';

    const data = {
        nome: document.getElementById('nome').value.trim(),
        cognome: document.getElementById('cognome').value.trim(),
        email: document.getElementById('email').value.trim(),
        reparti: Array.from(document.querySelectorAll('#reparti input:checked')).map(cb => cb.value),
        altroReparto: altroChk.checked ? document.getElementById('altro-reparto').value.trim() : '',
        reports: [
            document.getElementById('r1').value.trim(),
            document.getElementById('r2').value.trim(),
            document.getElementById('r3').value.trim(),
            document.getElementById('r4').value.trim(),
            document.getElementById('r5').value.trim()
        ].filter(v => v),
        note: document.getElementById('note').value.trim()
    };

    try {
        const res = await fetch('https://script.google.com/macros/s/AKfycby5Hbf3kGCDOujg4HmP_NUBOkx9pjo9UIfccWMG_m042bVTOQQV9UBYFxjNQ_U5FUiCnA/exec', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data),
            redirect: 'follow'
        });

        if (!res.ok) throw new Error('Risposta non OK');

        const result = await res.json();

        if (result.status === 'success') {
            formContainer.style.display = 'none';
            successScreen.style.display = 'block';
            window.scrollTo({top: 0, behavior: 'smooth'});
        } else {
            alert('Errore server: ' + (result.message || 'Risposta non valida'));
        }
    } catch (err) {
        console.error(err);
        alert('Problema di connessione o server. Riprova.');
    } finally {
        btnSubmit.disabled = false;
        btnSubmit.classList.remove('loading');
        btnSubmit.textContent = 'Invia Questionario';
    }
});
</script>
